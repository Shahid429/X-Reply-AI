const e={POST:'article[data-testid="tweet"], article[data-testid="tweetDetail"]',POST_TEXT:'div[data-testid="tweetText"]',POST_AUTHOR:'div[data-testid="User-Name"] a[role="link"]:last-child',REPLY_BUTTON:'div[role="button"][data-testid="reply"], [data-testid="reply"]',REPLY_BOX:'div[data-testid="tweetTextarea_0"], [data-testid="tweetTextarea_0"]'},t="ai-reply-btn",r="ai-reply-btn-loading",n="images/grok.png";const o=new WeakSet,a=new IntersectionObserver(a=>{a.forEach(a=>{a.isIntersecting&&a.target&&!o.has(a.target)&&(o.add(a.target),function(o){if(o.querySelector(`.${t}`))return;const a=o.querySelector(e.REPLY_BUTTON);if(!a)return;const s=document.createElement("div");s.className=t;const c=document.createElement("img");c.src=chrome.runtime.getURL(n),c.alt="AI Reply",s.appendChild(c);const l=a.parentElement;l?l.parentNode.insertBefore(s,l.nextSibling):a.parentNode.appendChild(s);s.addEventListener("click",async t=>{t.stopPropagation(),function(){const e=Date.now();return!(e-i<1500)&&(i=e,!0)}()?(await function(e=120,t=230){return new Promise(r=>setTimeout(r,e+Math.random()*t))}(),async function(t,n){try{n.classList.add(r);const a=t.querySelector(e.POST_TEXT),i=t.querySelector(e.POST_AUTHOR);if(!a)throw new Error("Could not find post text");const s=a.textContent.trim();i&&i.textContent.trim();let c;try{c=await(o=["personaPrompt","promptPreset"],new Promise((e,t)=>{try{chrome.storage.sync.get(o,r=>{const n=chrome.runtime&&chrome.runtime.lastError?chrome.runtime.lastError:null;n?t(new Error(n.message||"Failed to read settings")):e(r||{})})}catch(e){t(e)}}))}catch(e){if(function(e){if(!e)return!1;const t=e.toLowerCase();return t.includes("extension context invalidated")||t.includes("context invalidated")}(e.message))return alert("Extension updated. Reloading…"),void window.location.reload();throw e}const l="undefined"!=typeof window&&window.BUILT_IN_PROMPTS?window.BUILT_IN_PROMPTS:{},d=l[c.promptPreset||"prompt2"]||l.prompt2||"",u=`${c.personaPrompt&&c.personaPrompt.trim()?c.personaPrompt.trim():d||"Reply briefly like a real human and keep it natural."}\n\nHard rule: Do not include citations, references, links, or bracketed numbers like [1], [2], [3]. Do not append sources or footnotes.`,m=`Tweet: "${s}"\n\nReply:`,p=function(e){if(!e)return"";let t=e.replace(/\s*\[[0-9,\s]+\]\s*$/g,"").replace(/\s*https?:\/\/\S+$/gi,"").replace(/\n+/g," ").trim();t.length>280&&(t=t.slice(0,277).trimEnd()+"…");return t}(await new Promise((e,t)=>{chrome.runtime.sendMessage({type:"gen",payload:{systemInstruction:u,prompt:m}},r=>chrome.runtime.lastError?t(new Error("Generation failed.")):r?.error?t(new Error(r.error)):void e(r?.text||""))})),w=t.querySelector(e.REPLY_BUTTON);w&&w.click();const f=await function(e,t=2500,r=100){return new Promise(n=>{const o=Date.now(),a=setInterval(()=>{const r=document.querySelector(e);r?(clearInterval(a),n(r)):Date.now()-o>=t&&(clearInterval(a),n(null))},r)})}(e.REPLY_BOX,2500,100);if(!f)throw new Error("Could not open reply box");f.focus(),document.execCommand("insertText",!1,p)}catch(e){console.error("Error handling AI reply click:",e),alert(`Error: ${e.message}`)}finally{n.classList.remove(r)}var o}(o,s)):alert("Slow down a bit to stay safe.")})}(a.target))})},{root:null,rootMargin:"200px",threshold:0});let i=0;function s(){document.querySelectorAll(e.POST).forEach(e=>a.observe(e));new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{1===t.nodeType&&(t.matches&&t.matches(e.POST)?a.observe(t):t.querySelectorAll&&t.querySelectorAll(e.POST).forEach(e=>a.observe(e)))})})}).observe(document.body,{childList:!0,subtree:!0})}chrome.storage.local.get(["extensionConfig"],function(e){(e.extensionConfig||{enabled:!0}).enabled&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s())});